import{c as I}from"./index.s7pVKYCa.js";const b=[{id:"visual-story-v2",name:"Visual Story v2 (Main)",endpoint:"/webhook/visual-story-agent/chat"},{id:"movieagent-standalone",name:"MovieAgent (Story to Shots)",endpoint:"/webhook/movieagent-standalone/chat"},{id:"visual-intake",name:"Story Intake (New!)",endpoint:"/webhook/visual-story-intake/chat"},{id:"visual-story",name:"Visual Story Agent",endpoint:"/webhook/visual-story-agent/chat"},{id:"universal-v5",name:"Universal v5 (Memory)",endpoint:"/webhook/universal-v5/chat"},{id:"chip-agent-v2",name:"CHIP Agent v2",endpoint:"/webhook/chip-agent-v2/chat"},{id:"universal-agent",name:"Universal Agent",endpoint:"/webhook/test-universal/chat"}],k=I((o,f)=>({messages:[],isLoading:!1,error:null,chatSessionId:null,currentAgent:b[0],activeProject:null,projects:[],projectsLoading:!1,sendMessage:async(s,a)=>{const{chatSessionId:c,messages:n,currentAgent:m,activeProject:p}=f(),h=p?.id||c||`${a}_${Date.now()}`;c||o({chatSessionId:h});const v={id:`msg_${Date.now()}`,role:"user",content:s,timestamp:new Date};o({messages:[...n,v],isLoading:!0,error:null});try{const l=await fetch("/api/chat/send",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({chatInput:s,chatSessionId:h,projectId:p?.id,agentEndpoint:m.endpoint})});if(!l.ok){const t=await l.json();throw new Error(t.error||"Failed to send message")}const e=await l.json();let d=e.response||e.output||"";typeof d=="object"&&(d=JSON.stringify(d,null,2));const u=t=>{if(!t)return"";if(t.startsWith("http://")||t.startsWith("https://"))return t;const i=t.match(/db\\\\users\\\\(.+)/)||t.match(/db\/users\/(.+)/);return i?"/api/files/"+i[1].replace(/\\\\/g,"/").replace(/\\/g,"/"):t},r=[];if(e.media&&Array.isArray(e.media))for(const t of e.media)r.push({type:t.type||"image",url:u(t.url||t.path||t.localPath)});if((e.imageUrl||e.image_url)&&r.push({type:"image",url:u(e.imageUrl||e.image_url)}),(e.videoUrl||e.video_url)&&r.push({type:"video",url:u(e.videoUrl||e.video_url)}),e.localPath||e.local_path){const t=e.localPath||e.local_path,i=t.split(".").pop()?.toLowerCase(),g=["mp4","webm","mov"].includes(i)?"video":"image";r.push({type:g,url:u(t)})}if(e.urls&&(e.urls.image&&r.push({type:"image",url:u(e.urls.image)}),e.urls.video&&r.push({type:"video",url:u(e.urls.video)}),e.urls.all&&Array.isArray(e.urls.all))){for(const t of e.urls.all)if(!r.some(i=>i.url===t)){const i=t.split(".").pop()?.toLowerCase()||"",g=["mp4","webm","mov"].includes(i)?"video":"image";r.push({type:g,url:u(t)})}}const j=/https?:\/\/[^\s<>"{}|\\^`\[\]]+\.(png|jpg|jpeg|gif|webp|mp4|webm|mov)/gi,y=d.match(j)||[];for(const t of y){const i=t.split(".").pop()?.toLowerCase()||"",g=["mp4","webm","mov"].includes(i)?"video":"image";r.some(S=>S.url===t)||r.push({type:g,url:t})}const w={id:`msg_${Date.now()}_resp`,role:"assistant",content:d||"Done!",timestamp:new Date,media:r.length>0?r:void 0};o(t=>({messages:[...t.messages,w],isLoading:!1}))}catch(l){o({isLoading:!1,error:l instanceof Error?l.message:"Unknown error"});const e={id:`msg_${Date.now()}_err`,role:"assistant",content:`Error: ${l instanceof Error?l.message:"Failed to send message"}`,timestamp:new Date};o(d=>({messages:[...d.messages,e]}))}},clearMessages:()=>o({messages:[],chatSessionId:null,error:null}),setSessionId:s=>o({chatSessionId:s}),setAgent:s=>o({currentAgent:s,messages:[],chatSessionId:null,error:null}),fetchProjects:async()=>{o({projectsLoading:!0});try{const s=await fetch("/api/projects");if(s.ok){const a=await s.json();o({projects:a.projects||[],projectsLoading:!1})}else o({projectsLoading:!1})}catch(s){console.error("Failed to fetch projects:",s),o({projectsLoading:!1})}},createProject:async s=>{try{const a=await fetch("/api/projects",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:s})});if(a.ok){const c=await a.json(),n={id:c.projectId,name:c.name,thumbnail:null,modified:new Date().toISOString(),outputCount:0};return o(m=>({projects:[n,...m.projects],activeProject:n,chatSessionId:c.projectId,messages:[],error:null})),c.projectId}return null}catch(a){return console.error("Failed to create project:",a),null}},selectProject:async s=>{try{const a=await fetch(`/api/projects/${s}`);if(a.ok){const n=(await a.json()).project,m=(n.messages||[]).map((p,h)=>({id:`loaded_${h}_${Date.now()}`,role:p.role,content:p.content,timestamp:new Date(p.timestamp),media:p.media}));o({activeProject:{id:n.id,name:n.name,thumbnail:n.thumbnail,modified:n.modified,outputCount:n.outputCount},chatSessionId:n.id,messages:m,error:null})}}catch(a){console.error("Failed to select project:",a)}},clearProject:()=>o({activeProject:null,chatSessionId:null,messages:[],error:null})}));export{b as A,k as u};
